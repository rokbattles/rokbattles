"use strict";

const fs = require("node:fs/promises");
const path = require("node:path");
const yaml = require("yaml");

const YAML_EXTENSION_REGEX = /\.ya?ml$/i;

async function main() {
  const repoRoot = path.resolve(__dirname, "../../..");
  const datasetsDir = path.join(repoRoot, "datasets");
  const outputDir = path.resolve(__dirname, "../src/autogenerated");

  const entries = await fs.readdir(datasetsDir, { withFileTypes: true });
  const yamlFiles = entries.filter(
    (entry) => entry.isFile() && YAML_EXTENSION_REGEX.test(entry.name)
  );

  await fs.mkdir(outputDir, { recursive: true });

  for (const file of yamlFiles) {
    const sourcePath = path.join(datasetsDir, file.name);
    const targetPath = path.join(
      outputDir,
      file.name.replace(YAML_EXTENSION_REGEX, ".json")
    );

    const raw = await fs.readFile(sourcePath, "utf8");
    const documents = yaml.parseAllDocuments(raw);
    const parsed =
      documents.length <= 1
        ? (documents[0]?.toJSON() ?? null)
        : documents.map((doc) => doc.toJSON());

    const json = `${JSON.stringify(parsed)}\n`;
    await fs.writeFile(targetPath, json, "utf8");
  }

  console.log("Success");
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
